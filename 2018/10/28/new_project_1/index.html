<!DOCTYPE html><html><head><meta charset="utf-8"><title>신규 통합 CS 시스템 관리 개발기 # 설계편 | NonBlock</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="일단 지른다"><meta property="og:type" content="article"><meta property="og:title" content="신규 통합 CS 시스템 관리 개발기 # 설계편"><meta property="og:url" content="https://blog.javarouka.me/2018/10/28/new_project_1/index.html"><meta property="og:site_name" content="NonBlock"><meta property="og:description" content="일단 지른다"><meta property="og:locale" content="ko_KR"><meta property="og:image" content="https://blog.javarouka.me/asset/images/java-logo.png"><meta property="article:published_time" content="2018-10-27T15:00:00.000Z"><meta property="article:modified_time" content="2020-09-22T04:18:02.870Z"><meta property="article:author" content="JavaRouka"><meta property="article:tag" content="java"><meta property="article:tag" content="javascript"><meta property="article:tag" content="scaffolding"><meta property="article:tag" content="legacy"><meta property="article:tag" content="new-cs-system"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://blog.javarouka.me/asset/images/java-logo.png"><link rel="apple-touch-icon" sizes="57x57" href="/fav/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/fav/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/fav/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/fav/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/fav/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/fav/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/fav/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/fav/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/fav/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/fav/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/fav/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/fav/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/fav/favicon-16x16.png"><link rel="manifest" href="/fav/manifest.json"><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/fav/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><meta name="keywords" content="java,javascript,scaffolding,legacy,new-cs-system"><link href="https://fonts.googleapis.com/css?family=Lato:400,400i,700" rel="stylesheet"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-85661914-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-85661914-1")</script><link rel="stylesheet" href="/icomoon/style.css"><link rel="stylesheet" href="/style.css"><script type="text/javascript">var __sauron=__sauron||[];__sauron.push(["pageview"]),function(){var e="https://analy1.sauroneyes.com/";__sauron.push(["setTrackerUrl",e+"analytics/"]);var a=document,r=a.createElement("script"),s=a.getElementsByTagName("script")[0];r.type="text/javascript",r.async=!0,r.defer=!0,r.src=e+"js/sauron.js",s.parentNode.insertBefore(r,s)}()</script><meta name="generator" content="Hexo 5.2.0"><link rel="stylesheet" href="/css/prism.css" type="text/css"><link rel="alternate" href="/atom.xml" title="NonBlock" type="application/atom+xml">
</head><body><div class="site-wrapper"><div id="loading-bar-wrapper"><div id="loading-bar"></div></div><script>document.getElementById("loading-bar").style.width="20%"</script><header id="header" class="site-header clearfix"><a class="logo square clearfix" href="/"><span class="b">N </span><span class="w">o </span><span class="b">n </span><span class="b">B </span><span class="b">l </span><span class="w">o </span><span class="b">c </span><span class="w">k </span></a><a class="me square site-nav-switch clearfix"><span class="b"><span class="icon icon-menu"></span></span></a></header><aside class="category-wrapper"><div class="site-category"><a class="nav flex-column-link" href="/categories/effective-java/">Effective Java</a><a class="nav flex-column-link" href="/categories/review/">Review</a><a class="nav flex-column-link" href="/categories/tech/">Tech</a><a class="nav flex-column-link" href="/categories/tech/translate/">Translate</a><a class="nav flex-column-link" href="/categories/book/">book</a><a class="nav flex-column-link" href="/categories/java/">java</a><a class="nav flex-column-link" href="/categories/java/kotlin/">kotlin</a><a class="nav flex-column-link" href="/categories/javascript/">javascript</a><a class="nav flex-column-link" href="/categories/javascript/react/">react</a><a class="nav flex-column-link" href="/categories/javascript/react/redux-saga/">redux-saga</a><a class="nav flex-column-link" href="/categories/kotlin/">kotlin</a><a class="nav flex-column-link" href="/categories/kotlin/tech/">tech</a><a class="nav flex-column-link" href="/categories/kotlin/tech/translate/">translate</a></div><div class="search"><form name="searchform" id="searchform" class="u-search-form"><input type="text" id="searchinput" class="u-search-input st-default-search-input" data-list-highlight="true" data-list-value-completion="true" placeholder="Looking for something in this blog?"> <button type="submit" id="u-search-btn-submit" class="u-search-btn-submit"><span class="icon icon-search"></span></button></form></div><script>document.getElementById("loading-bar").style.width="40%"</script><main id="main" class="clearfix"><article id="post-new_project_1" class="article white-box article-type-post" itemscope itemprop="blogPost"><header class="article-header"><h1 class="article-title" itemprop="name">신규 통합 CS 시스템 관리 개발기 # 설계편</h1><h2 class="article-sub-title">일단 지른다</h2><div class="article-meta">Posted on <time class="article-time" datetime="2018-10-27T15:00:00.000Z" itemprop="datePublished">2018-10-28</time></div></header><div class="article-entry" itemprop="articleBody"><hr><ul><li>신규 통합 CS 시스템 관리 개발기 # 설계편 #</li><li><a href="/2018/11/23/new_project_2/">신규 통합 CS 시스템 관리 개발기 # 혼란편 #</a></li></ul><hr><h2 id="Customer-Service-관리-시스템-개발"><a href="#Customer-Service-관리-시스템-개발" class="headerlink" title="Customer Service 관리 시스템 개발"></a>Customer Service 관리 시스템 개발</h2><p>전자상거래의 CS 관리 시스템이라는 건 생각보다 복잡하다.</p><ul><li>회원정보 조회</li><li>회원 정보 (아이디, 계좌, 주소지 …때로는 탈퇴처리) 변경</li><li>이 회원이 주문한 내역</li><li>이 회원이 최근 주문한 상품</li><li>이 회원의 상담 이력</li><li>상품 판매 업체와 연동</li><li>택배 연동</li><li>메시지, 전화 등의 Channel 연동</li><li>etc …</li></ul><p>사실상 전자상거래의 모든 도메인이 다뤄진다고 볼 수 있다.</p><p>그만큼 의존성이 문어발 식으로 연결되어있고, 그 만큼 타 도메인의 변화에 영향을 많이 받는다.</p><p align="center"><img src="/asset/new_project/octocat.png" alt="나...?"><em>나 말하나...?</em></p><p>과장하면 타 도메인에서 재채기를 하면 감기에 걸릴수도 있는게 CS 관리 프로그램이다.</p><h2 id="버틸수가-없다"><a href="#버틸수가-없다" class="headerlink" title="버틸수가 없다"></a>버틸수가 없다</h2><p>MSA(<code>M</code>icro <code>S</code>ervice <code>A</code>rchitecture) 환경에서 동시다발적으로 벌어지는 각 도메인들의 변화를 추적하고 반영하다보면, 쉴새없는 오류와, 호환성 문제를 겪게 된다.</p><p>이런 상황을 잘 관리하지 못하면 결과는 끔찍하다.</p><p>쓰레기를 가득 실은 트럭이 도로 제한속도를 넘어 과속하는 것만으로 위험한데, 이 트럭이 사고가 나 전복된다면 쓰레기들이 도로를 가득 메우는 상황이 펼쳐질 것이다.</p><p>아마 CS 개발자 대부분이 어떤 로직에 추가사항을 넣으려고 할때</p><blockquote><p>이 코드는 누가 만들었지?!</p></blockquote><p>하며 <code>git blame</code> 을 (혹은 annotation) 을 안해본 사람이 없을 것이다.</p><p>(때로는 만든 사람이 자신인 웃기는 경우도 있다…)</p><p>테스트 코드 부재는 예사이고, 팀원들끼리 충분한 커뮤니케이션이 없으면 중복된 코드가 각자의 개성으로 암세포처럼 자라난다.</p><p>그 코드가 관련된 도메인이 변할 경우 이곳저곳에서 자란 해당 코드 모두가 수정되어야 한다.<br>새 기능이 추가될 때 하나라도 이 부분을 누락하면 바로 장애로 이어지거나 유지보수 이슈가 등록된다.</p><p>리팩토링에도 한계가 있다.</p><p>리팩토링 범위를 아무리 최소로 해도 하다보면 너무나 광범위한 영역을 다루게 되며 결국 포기하는 일이 많다. 리팩토링이 때로는 새로운 버그를 만들기도 한다. 이건 이 경우와는 별개로 애초에 잘못된 습관 탓도 있고, 다른 상황에서도 마찬가지인 경우가 많긴 하다.</p><p align="center"><img src="/asset/new_project/zealot.jpeg" alt="버틸..."><em>버틸수가 없다!</em></p><p>이런 환경속에서 부족한 리소스로 일을 진행하면서 몇차례의 개편을 하다보니 코드의 유지보수성에 많은 생각을 하게 되었다.</p><ul><li>외부 변화에 큰 타격이 없을 것</li><li>도메인 대응이 늦어도 해당 도메인의 기능을 제외하고는 정상 동작해야 할것</li><li>서버와 클라이언트의 분리가 될 것</li><li>새 기능의 추가가 쉬울 것</li><li>프로그램 속도에 문제가 없을 것</li><li>코드가 Readable 할 것</li><li>재미있을 것(?)</li></ul><p>이런 생각이 정리되어 가던 때에 드디어 다시한번 개편을 시도할 기회가 생기게 되었다. 신규 주문정보의 개편이 시작된 것이다. 이번이 나에겐 4번째이다.</p><p>그동안 고민했던 문제들을 쭉 펼쳐보고 기존에서 바꾼 방법을 하나하나 적어보겠다.</p><p>모든 것은 <code>팀원들과의 회의를 통해 결정</code> 했다. 이 과정은 상당히 길고 잦었지만 그 시간은 상당히 유익했던 시간이었다</p><h2 id="새로운-방법"><a href="#새로운-방법" class="headerlink" title="새로운 방법"></a>새로운 방법</h2><h3 id="Layer"><a href="#Layer" class="headerlink" title="Layer"></a>Layer</h3><p>기존의 구조는 Spring 의 Controller - Service - Repository or Domain API 의 정석적인(?) 구조였다.</p><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://zetawiki.com/wiki/%EB%8F%84%EB%A9%94%EC%9D%B8_%EC%A3%BC%EB%8F%84_%EC%84%A4%EA%B3%84_DDD">DDD</a> 방식으로의 전환도 고려해보았지만, 5년을 넘게 일해도 이해할 수 없는 여러 비즈니스들과 도메인 개념들, 그리고 팀 전체적으로 (나 포함) 낮은 DDD 숙련도 등으로 그냥 전통적인 Controller - Service - Repository or Domain API 로 결정했다.</p><p>약간 아쉽기도 하지만, 시간이라는 제약도 있고 익숙하지 않은 모험을 하기에는 약간 위험했다.</p><p>다만 저 기본적인 흐름에 레이어링을 적용하기로 했다.</p><ul><li><code>Controller</code><ul><li>외부 요청을 처리하는 용도. 일반적인 Controller.</li></ul></li><li><code>Service</code><ul><li>요청에 대한 비즈니스 로직의 묶음. 비즈니스가 변할 경우 서비스만 재작성하면 된다.</li><li>여러 비즈니스 단위 모듈 의존성을 주입받아 처리한다. 하나의 의존성만 있을 수 있고, 여러 비즈니스가 얽힌 의존성이 처리될 수도 있다.</li></ul></li><li><code>Business Logic Behavior</code><ul><li>단일 비즈니스를 처리하기 위한 모듈</li><li>Repository 등에 의존성이 있다.</li></ul></li><li><code>Repository</code><ul><li>팀 오너십 데이터에 대한 CRUD 및 외부 API 에 대한 래퍼.</li><li>Repository 와 Api 를 나누려고 했으나 그냥 하나의 레이어로 래핑하기로 함.</li></ul></li><li><code>Helper</code><ul><li>유틸리티. 무상태이거나 Controller, Service, Behavior, Repository 에는 의존성이 없는 모듈.</li><li>순수 함수들의 집합.</li></ul></li></ul><p>Helper 를 제외한 각 레이어끼리는 의존성을 걸지 않는게 기본이다.</p><p>초창기에는 Collector Layer 도 추가했지만, 나중에 설명할 <code>데이터 토막치기</code> 덕분에 잘 쓰이지 않아 사장되었다. Collector 는 각 데이터를 Aggregation 하는 레이어였다.</p><h3 id="DTO"><a href="#DTO" class="headerlink" title="DTO"></a>DTO</h3><p>DTO 도 구분했다.</p><p align="center"><img src="/asset/new_project/dto.jpeg" alt="박스"><em>데이터의 포장에도 각자의 목적이 있다</em></p><p>기본적으로 Request 로 받는 Condition 류를 제외한 모든 DTO 에는 모든 필드가 <code>final</code> 로 불변객체이다.</p><p>불변이 아닐 경우 각 로직이나 레이어를 거치면서 전달되는 객체의 필드가 실제 값이 있는지, 중간에 값이 어떻게 변하는지, 등의 상황에서 한 레이어만 보고서는 추적이 되지 않기 때문이다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * 확장성이 없고 반드시 필요한 순서대로 호출해야만 한다.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// 주문정보를 읽는다</span></span><br><span class="line">DetailOrderDTO order = <span class="keyword">this</span>.readOrderData(orderId);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 주문에 상품정보를 넣는다</span></span><br><span class="line">order = productModule.appendProductData(order);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 주문에 업체정보를 넣는다</span></span><br><span class="line">order = vendorModule.appendVendorData(order);</span><br></pre></td></tr></table></figure><p>이러한 로직이 있을 경우 <code>productModule.appendProductData</code>, <code>vendorModule.appendVendorData</code> 는 주문의 특정 필드의 nullable 여부가 중요해진다. 게다가 상품에 업체정보가 있으므로 앞선 로직에서 상품정보가 정상적이지 않을 경우 다음 업체정보도 얻을 수 없게 된다.</p><p>이 상황에서는 필드의 초기화 여부와 각 모듈의 호출 순서가 매우 중요하다. 이 규칙아래 에서 모듈 의존성 뿐 아니라 로직 의존성까지 발생한다.</p><p>리팩토링을 할 때도 문제가 된다.</p><p>각 모듈 호출 순서를 반드시 지켜야 하며 각 모듈안의 로직을 자세히 살펴보고 완전히 로직을 파악한 뒤에야 리팩토링을 할 수 있다.</p><p>하지만, 모든 필드가 <code>final</code> 일 경우 어떠한 DTO 를 전달받았을 경우 각 필드들이 반드시 초기화가 되었다는 걸 의미하기에 앞선 문제의 대부분이 해소된다. 어디선가 전달받은 객체라도 값의 내용물에 대해 안심하고 쓸 수 있다는 뜻이다. (필드의 Null 여부가 아니라 초기화 여부를 말한다)</p><p>각 레어이간 데이터는 다음과 같은 기준으로 정했다. 네이밍이 약간 이상한것 같지만 그런가보다 하자;</p><ul><li><code>VO</code><ul><li>Repository 등에서 얻는 기본 데이터.</li></ul></li><li><code>Condition</code><ul><li>Client 의 요청 데이터. 불변처리가 힘들기에 일반적인 Setter 가 달려있다.</li></ul></li><li><code>Form</code><ul><li>비즈니스 로직 단위의 요청 폼. 대부분 서비스에서 생성되어 각 비즈니스 처리기에 전달된다.</li></ul></li><li><code>Result</code><ul><li>각 VO 를 수집하여 Client 가 요구하는 데이터로 빌드되는 DTO</li></ul></li></ul><p>예를 들면, MemberFindCondition 으로 요청되면 서비스는 그 요청으로 각 비즈니스에 MemberFindForm, MemberBlockForm, MemberXXXForm 등을 만들어 처리하고 그 결과를 MemberFoundResult 로 응답한다.</p><h3 id="Data-Aggregation"><a href="#Data-Aggregation" class="headerlink" title="Data Aggregation"></a>Data Aggregation</h3><p>다양한 도메인을 한번에 다루는 CS 특성상 여러 도메인의 데이터를 조합하는 경우가 많다.</p><p align="center"><img src="/asset/new_project/bibim.jpeg" alt="비빔밥" title="비빔밥"><em>재료를 잘 섞어야 맛있다.</em></p><p>어디에도 끼는 회원이나 상품 말고도 CS의 99% 이상의 문의가 주문 관련이니 주문 데이터와 주문에 따라오는 배송 데이터 등은 항상 데이터 조합 대상이다.</p><p>기존 시스템은 클라이언트 요청에 서버는 각 도메인의 데이터를 한번에 합쳐서 보여주는 방식으로 동작했다. 가령 회원이 최근에 주문한 데이터를 봐야 한다면 회원정보, 주문정보, 상품정보, 배송정보, 취소정보를 읽은 뒤 조합했다.</p><p>요청이 하나만 있을 경우에는 이 방법도 나쁘지 않지만, 요청이 다수가 겹칠 경우 문제가 될 수 있다. 요청하는 데이터끼리 중복되는 데이터를 포함할 수 있기 때문이다.</p><p>최근 주문목록을 보여주는 컴포넌트가 있고 주문목록에서 특정 주문을 선택할 경우 다시 해당 주문의 상세를 보여주는 UI가 있다고 가정한다면,<br>매 요청의 응답에는 공통적으로 연관 상품정보, 취소정보, 결제정보, 배송정보가 포함되게 된다.</p><p>불필요한 반복적 요청이 되는 셈이다.</p><p>게다가 비즈니스의 변화로 데이터에 변화가 생길 경우 각 화면별로 더 추가되거나 제거될 수 있어 수정도 동시에 여러 군데에서 일어난다.</p><p>이런 방법보다 데이터의 조합은 연관결합도가 높은 것끼리만 하고, 공통적인 데이터는 분할 요청하는 방식을 선택했다.</p><p>난 이걸 <code>데이터 토막치기</code> 라고 (나 혼자 쓰는 용어이다) 명명했다.</p><h3 id="데이터-토막치기"><a href="#데이터-토막치기" class="headerlink" title="데이터 토막치기"></a>데이터 토막치기</h3><p align="center"><img width="320" src="/asset/new_project/Dr Salvador.jpg" alt="닥터 살바도르" title="닥터 살바도르"><em>토막쳐보자... 부우우우우웅!!</em></p><p>최근 주문목록에 필요한 데이터를 조합한다고 가정해보자</p><ol><li>회원정보 요청</li><li>회원이 주문한 내역 리스트 데이터를 최근 순으로 요청</li><li>주문내의 정보로 다음 정보 요청<ul><li>주문 내의 상품정보로 상품 정보 요청</li><li>주문 아이디로 결제 정보 요청</li><li>주문 아이디로 취소 정보 요청</li></ul></li><li>상품 정보가 응답되면 그 정보로 다시 업체 정보 요청</li><li>상품 정보로 상품의 각 배송타입, 유형, 카테고리 정보 요청</li></ol><p>각 정보를 조합해서 화면에 표시한다.</p><p>여기서 다시 특정 주문의 상세를 보고 싶다고 한다면 앞서 요청한 상품상세와 각 메타데이터, 업체, 결제, 취소 정보는 요청하지 않아도 된다.<br>필요한 상세 데이터를 추가 요청한뒤 데이터를 조합하면 끝이다.</p><p>그리고 다른 주문번호를 보다가 다시 같은 주문 상세를 조회할 경우, 이미 로딩된 정보를 활용할 수도 있다.<br>어떤 데이터 종류는 갱신이 자주 되는 데이터는 만료 관리가 필요하거나 아예 새로 로딩해야 할 때도 있지만, 대부분의 경우 앞서 설명한 <code>로딩된 데이터끼리의 조합</code> 방식이 훨씬 유리하다.</p><p>이렇게 데이터를 최대한 분할하여 재활용성과 서버 자원 낭비를 줄이고 성능 향상도 고려했다. 모든 데이터를 토막치는게 아닌 비즈니스나 UI 상황, 효율및 결합도에 따라 데이터 구성을 하여 합치는게 유리하다는 것도 잊지 않았다.</p><p>마침 적용하려고 하는 상태관리기 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://lunit.gitbook.io/redux-in-korean/">Redux</a> 의 selector 개념과 이를 보좌해주는 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/reduxjs/reselect">Reselect</a> 는 이런 방식에 찰떡 궁합이었고, 디렉토리 구조도 그에 맞게 가져갔다.</p><h2 id="서버-기반을-수정해보자"><a href="#서버-기반을-수정해보자" class="headerlink" title="서버 기반을 수정해보자"></a>서버 기반을 수정해보자</h2><p>서버 개발에서는 특별한 개선을 하기 어려웠다.</p><p>프로젝트를 온전하게 새로 설정했으면 좋았겠지만, 기존부터 쌓인 코드에 의존성이 상당하고 타 팀의 코드도 섞여 있기에 서버의 완전한 새판 짜기는 불가능했다. 위에 설명했던 레이어링 및 패키지와 설정 파일의 분리 정도가 가능했고, 나머지 모듈 의존성 등은 크게 손댈 수 없었다.</p><p>기회가 된다면 Spring Boot 부터 Mbean 등을 좀 더 잘 써보고 싶은데… 한다면 팀 스탠드얼론이 가능한 프로젝트에나 도입할 수 있을 것 같아 아쉽다.</p><p align="center"><img width="320" src="/asset/new_project/simu.jpg" alt="ㅠㅠ" title="ㅠㅠ"><em>OTL</em></p><h2 id="클라이언트-기반을-수정해보자"><a href="#클라이언트-기반을-수정해보자" class="headerlink" title="클라이언트 기반을 수정해보자"></a>클라이언트 기반을 수정해보자</h2><p>클라이언트는 이야기가 달라서 완전한 재설정이 가능했다.</p><p>클라이언트쪽은 기존의 나쁜 냄새를 모두 제거하기 위해 바닥부터 새로 시작하기로 했다.</p><ul><li>Global N Sub 방식의 Multi-Store</li><li>클라이언트 사이드 라우팅</li><li>스크립트 용량 축소</li><li>컴포넌트의 재사용성</li><li>사용자 액션 추적</li><li>에러 리포트</li></ul><h3 id="Multi-Store"><a href="#Multi-Store" class="headerlink" title="Multi Store"></a>Multi Store</h3><p>Redux 는 기본적으로 단일 스토어를 추천한다.</p><p>하지만 새로 개편하는 어플리케이션에는 단일 스토어의 이점이 전혀 떠오르지 않았다.</p><p>데이터가 각 회원 혹은 주문 단위로 휘발성이며 상태들의 재사용성이나 히트율이 낮고, 동일한 구조의 회원이나 주문 등의 컨텍스트만 다른 데이터가 대다수이다.</p><p>이 역시 컨텍스트가 바뀌면 버려진다.</p><p>게다가 개편 대상인 어플리케이션은 동적 탭 단위의 구조이다. 같은 탭이 여러개 열릴 수도 있다. 그러면 탭마다 관리되는 상태는 컨텍스트마다 종속 데이터를 관리해야 한다.</p><p>또한 탭이 바뀌거나 하면 화면의 모든 요소를 새 화면의 컨텍스트에 맞게 계산하고, 컴포넌트를 렌더링해야 한다. 탭 하나가 굉장히 많은 데이터를 가질텐데, 단순한 탭의 스위칭만으로 모든 요소가 새로 그려질 것이고 그만큼 화면의 부하는 커진다.</p><p>컨텍스트에 따른 reducer - state 설계도 만만치 않은데다, 성능저하는 단일 스토어에 대해 깊이 생각해보게 되었다.</p><p>결론은 전역 스토어는 하나 두고, 특정 컨텐츠 탭에 대해서는 서브 스토어를 생성하며 스토어를 가진 탭이 닫힐 경우 상태를 정리하는 것보다 그냥 그 스토어를 버리는 구조로 정하게 되었다.</p><p>자식 스토어는 선택적으로 부모 스토어에서 상태를 구독할 수 있고, 액션중 특정 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://developer.mozilla.org/ko/docs/Glossary/Symbol">Symbol</a> 을 통해 전역 스토어에도 dispatch 를 할 수 있도록 설계했다.</p><h3 id="클라이언트-라우팅"><a href="#클라이언트-라우팅" class="headerlink" title="클라이언트 라우팅"></a>클라이언트 라우팅</h3><p align="center"><img width="320" src="/asset/new_project/routing.jpeg" alt="표지판" title="표지판"><em>이리저리 가시오</em></p><p>라우팅 기능을 하는 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/ReactTraining/react-router">React-Router</a> 라는 훌륭한 라이브러리가 이미 존재하고, 이걸 쓰면 되겠지 라고 생각했다.</p><p>그러나 이리저리 돌려본 결과는 실제 CS 툴에는 그리 어울리지 않다는 결론을 내렸다.</p><p>다음과 같은 이유에서다.</p><ul><li>단일 스토어에 최적화되어 있다.</li><li>라우팅이 바뀔 경우 현재 스토어의 state 에 따라 컴포넌트를 새로 렌더링하는데, 만들려는 어플리케이션은 잦은 라우팅 변경이 있어서 성능 문제가 생긴다</li><li>props 가 아닌 state 의 관리가 어렵다</li></ul><p>결국 React Router 에서 Route 기능만을 빌려와서 직접 라우팅 시스템을 구현할 수밖엔 없었다.</p><p>겸사겸사 React Router 에서 지원하기 좀 애매한 동적 모듈 로딩 라우팅도 적용했다. (개발 당시에는 없었는데 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://reactjs.org/docs/code-splitting.html##reactlazy">지금 버전에서는 잘 지원</a>하고 있더라…)</p><p>사용한 라이브러리는 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/kriasoft/universal-router">Univasal-Router</a> 이다.</p><p>단순하지만 프로젝트에서 필요로 하는 모든 기능이 들어있었다.</p><h3 id="스크립트-용량-축소"><a href="#스크립트-용량-축소" class="headerlink" title="스크립트 용량 축소"></a>스크립트 용량 축소</h3><p>위에 잠깐 언급되었지만 기존 시스템의 스크립트 용량은 무려 5mb 였다.</p><p>어플리케이션에 사용되는 모든 스크립트를 하나의 파일로 만들어서 한번어 로딩하는 방식이었기 떄문이다.</p><p>이 방법으로 인해 성능이 느리거나 네트워크가 불량할 경우 어플리케이션이 상당히 느려졌었고, 브라우저으 javascript 성능이 다소 안좋을 경우 (IE…) 페이지가 한참동안 흰색으로 보이거나 Timeout 에 걸리는 <code>백화 현상</code> 이라는 일이 발생했었다.</p><p>이번에는 필요한 자원이 있을때 로딩하는 동적 로딩을 도입하기로 했다.</p><p>동적 로딩은 간단했다. webpack, babel 조합으로 간단히 import 구문으로 구현할 수 있었고, webpack 의 chunkName 조합으로 디버깅 및 파일 이름 지정도 가능했다.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 동적 컴포넌트 예시</span></span><br><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> loadComponent = <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&#x27;component/DynamicComponent&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyComponent</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.state = &#123;</span><br><span class="line">        DynamicComponent: <span class="literal">null</span>,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    componentDidMount() &#123;</span><br><span class="line">        loadComponent().then(<span class="function"><span class="params">DynamicComponent</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">                DynamicComponent</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; DynamicComponent &#125; = <span class="built_in">this</span>.state;</span><br><span class="line">        <span class="keyword">if</span>(!DynamicComponent) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;DynamicComponent /&gt;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>적용 후 첫 로딩 스크립트의 용량이 300kb 도 안될 정도로 좋아진 걸 보고 꽤나 좋았던 기억이 난다.</p><h3 id="컴포넌트-재사용성"><a href="#컴포넌트-재사용성" class="headerlink" title="컴포넌트 재사용성"></a>컴포넌트 재사용성</h3><p>이 문제는 참 어렵다.</p><p>재사용성을 아무리 고려해도 실제 이리저리 재활용을 하려고 하면 각자의 조금씩 다른 요구사항과 스타일 등에 버려지는 케이스가 많기 때문이다. 재활용성이 높은 컴포넌트는 무엇보다 이런 고민이 잘 커버되는 설계가 상당히 중요하다.</p><p>설계 능력이 그리 좋지 못한 덕분에 나는 아직도 재활용성이 높은 컴포넌트가 뭔지 헤메이고 있다.</p><p>그래도 노력이 나를 조금이나마 동정했는지, 몇몇 컴포넌트는 재사용성을 확보할 수 있었다. 디자인 요소를 배제할수록, 도메인 이해도가 높을 수록 재사용성이 높았던 것 같다.</p><ul><li>PureComponent 를 최대한 다수를 생성하려고 했다. 재활용의 시작이 되니까. React 16.6 에서는 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://reactjs.org/docs/react-api.html#reactmemo">React.memo</a> 라는 것도 지원해서 PureComponent 사용이 더 좋아졌다.</li><li>재활용 요소는 가급적 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://reactjs.org/docs/fragments.html">React.Fragment</a> 로 래핑한다. 이 요소가 어느 레이아웃으로 재활용될지 모르기 때문이다.</li><li>스타일 요소는 하나하나를 스타일링하지 말고 Styled-Component 로 대체할 수 있게 디자인한다.</li></ul><h3 id="사용자-액션-추적-에러-리포트"><a href="#사용자-액션-추적-에러-리포트" class="headerlink" title="사용자 액션 추적 / 에러 리포트"></a>사용자 액션 추적 / 에러 리포트</h3><p>이 문제는 사실 Redux의 middleware 만 잘 활용하면 달성이 쉽다.</p><p>다만, 액션으로 잡히지 않는 것까지 모두 처리하려면 직접적인 상태 변화가 없는 (다시 말하면 reducer 에서 처리하지 않는) 액션까지 디테일하게 설계해야 한다.</p><p>이런 건 보통 사이드이펙트 뿐인 작업을 수행할 때 발생하는데, 이런 것에 잘 어울리는 방식을 찾다가 Redux-Saga 를 도입하기로 했다.</p><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/redux-saga/redux-saga">Redux-Saga</a> 는 Redux 플로우에서 사이드이펙트를 관리하기 위한 미들웨어이다.</p><p>Redux Saga 로 사용자의 모든 행동은 Saga 를 통해 로깅되며 사이드이펙트로 서버에 리포트되도록 했다.</p><p>이런 액션 로깅은 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.elastic.co/kr/products/elasticsearch">Elastic Search</a> 등으로 쌓아서 통계나 어플리케이션 사용 행태를 분석하는 용도로 쓰려고 준비중이다.</p><p>사용자의 흐름이나 행동 및 발생하는 에러를 분석하면 버그나 기능 개선, 사용율 체크에 큰 도움이 되지 않을까 한다. 에러 시에는 현재 상태의 스냅샷을 전송한다면 재현도 어렵지 않게 할 수 있기에 처리가 좀 더 쉬울것이라 예상한다.</p><p>서비스를 해봐야 알겠지만…</p><h3 id="클라이언트-단독-개발이-가능하도록"><a href="#클라이언트-단독-개발이-가능하도록" class="headerlink" title="클라이언트 단독 개발이 가능하도록"></a>클라이언트 단독 개발이 가능하도록</h3><p align="center"><img width="320" src="/asset/new_project/front-back.jpg" alt="프론트 엔드 백엔드" title="Front Castle on Back"><em>프론트 엔드 성 아래의 백 엔드 심해</em></p><p>요청사항에 따라 클라이언트 개발만 진행하거나 소소한 수정건이 있을 수 있다. 이런 경우 예전의 구조에서는 클라이언트 수정이라도 로컬 서버를 먼저 실행시키고 로컬 서버를 구동하여 개발을 진행했다.</p><p>이 방법이 나쁜건 아니나 어차피 현재 구조에서는 페이지 라우팅을 클라이언트에서 하는데다가, 인증과 데이터 말고는 서버가 화면에 하는 일이 없기때문에 굳이 클라이언트 수정할때 무거운 local WAS 를 실행시킬 필요가 없다고 생각했다.</p><p>이 구조에서는 데이터만 제공된다면 클라이언트 개발에는 무리가 없다.</p><p>가상 데이터를 제공할 수 있는 mock 서버를 시작하고 가상 데이터를 내려주는 로컬 서버를 시작하고 webpack-dev-server 를 mock 서버에 연결하는 작업으로 로컬서버만으로 개발이 가능하게 되었다.</p><p>mock 서버는 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/smollweide/node-mock-server">node-mock-server</a> 을 사용했다.</p><p>문서가 다소 부족해서 사용법 사용에 애를 먹었지만, 파일 기반으로 GET, POST, PUT, DELETE 등 지원에 커스텀 파라미터에 따른 커스텀 데이터 생성기능까지 쓸만한 기능은 다 있어서 단순한 기능 사용에는 문제가 없었다.</p><p>webpack-dev-server 와 mock 연동에는 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.npmjs.com/package/express-http-proxy">express-http-proxy</a> 를 사용했다.</p><p>이 방법으로 mock 연계를 하고나니 좀 더 나아가서 실제 서버로 화면 개발을 진행할 수 있을것 같았다.</p><p>추가 개발은 proxy 에 https 지원을 추가하고 npm 스크립트를 몇개 수정한 것 뿐으로 훌륭한 실서버 &lt;==&gt; webpack-dev-server 의 연계가 만들어졌다.</p><p>이 작업으로 클라이언트 개발 매우 편해져서 작업 효율이 크게 증가했다.</p><h2 id="아직이다"><a href="#아직이다" class="headerlink" title="아직이다"></a>아직이다</h2><p>지금까지 개선과 설계 방향을 쭉 나열한 것 같다.</p><p><a href="/2018/11/23/new_project_2/">다음 글</a> 에는 이러한 개념을 적용하며 겪은 문제점과 아쉬운 부분을 나열해보겠다.</p></div><div class="article-tags"><a class="tag-none-link" href="/tags/java/" rel="tag">java</a><a class="tag-none-link" href="/tags/javascript/" rel="tag">javascript</a><a class="tag-none-link" href="/tags/legacy/" rel="tag">legacy</a><a class="tag-none-link" href="/tags/new-cs-system/" rel="tag">new-cs-system</a><a class="tag-none-link" href="/tags/scaffolding/" rel="tag">scaffolding</a></div><section id="comments" class="white-box"><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></section></article><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5bf3f68d0a53e4d6"></script><script>document.getElementById("loading-bar").style.width="60%"</script></main><footer id="footer" class="clearfix"><div>&copy; <a href="https://blog.javarouka.me">NonBlock</a> Theme by <a href="http://artifact.me/" target="_blank" rel="external nofollow noopener noreferrer">Art Chen</a>.</div><div>Powered by <a target="_blank" href="https://hexo.io/" rel="external nofollow noopener noreferrer">Hexo</a>.</div></footer><script>document.getElementById("loading-bar").style.width="80%"</script><div class="overlay"></div></aside></div><div class="site-sidebar"><div class="sidebar-switch clearfix show" style="display:block"><a class="dark-btn active" data-toggle="toc"><span class="icon icon-list"></span> <span class="text">Index</span> </a><a class="dark-btn" data-toggle="bio"><span class="icon icon-person"></span> <span class="text">Bio</span></a></div><div class="site-bio" style="display:none"><div class="about-me clearfix"><div class="avatar"><img src="https://avatars2.githubusercontent.com/u/1438503?v=4&s=250"></div><div class="info"><a class="name dark-btn" href="/about">JavaRouka</a></div><div class="info"><span class="item desc">javarouka 의 기술블로그</span></div></div><div class="social clearfix"><a href="/atom.xml" class="feed" target="_blank" rel="external"><span class="icon icon-feed"></span> </a><a href="mailto:javarouka@gmail.com" class="mail" target="_blank" rel="external nofollow noopener noreferrer"><span class="icon icon-mail"></span> </a><a href="https://github.com/javarouka" class="github" target="_blank" rel="external nofollow noopener noreferrer"><span class="icon icon-github"></span> </a><a href="https://www.facebook.com/hanghui.i" class="facebook" target="_blank" rel="external nofollow noopener noreferrer"><span class="icon icon-facebook"></span></a></div><div class="shortcuts clearfix"><div class="bk"><a href="#header" class="dark-btn window-nav"><span class="icon icon-chevron-thin-up"></span> <span class="text">Back to Top</span></a></div><div class="bk"><a href="#footer" class="dark-btn window-nav"><span class="icon icon-chevron-thin-down"></span> <span class="text">Go to Bottom</span></a></div></div></div><div class="site-post-nav show" style="display:block"><div class="site-post-nav-box"><a href="/2018/11/10/effective-java/" class="icon icon-chevron-thin-left"><a href="/2018/11/10/effective-java/" class="site-post-nav-text">Effective Java 3th 정리노트</a></a></div><div class="site-post-nav-box"><a href="/2018/01/01/inline-styles/" class="site-post-nav-text">Inline styles</a> <a href="/2018/01/01/inline-styles/" class="icon icon-chevron-thin-right"></a></div></div><div class="site-toc show" style="display:block"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Customer-Service-%EA%B4%80%EB%A6%AC-%EC%8B%9C%EC%8A%A4%ED%85%9C-%EA%B0%9C%EB%B0%9C"><span class="toc-number">1.</span> <span class="toc-text">Customer Service 관리 시스템 개발</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%EB%B2%84%ED%8B%B8%EC%88%98%EA%B0%80-%EC%97%86%EB%8B%A4"><span class="toc-number">2.</span> <span class="toc-text">버틸수가 없다</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%EC%83%88%EB%A1%9C%EC%9A%B4-%EB%B0%A9%EB%B2%95"><span class="toc-number">3.</span> <span class="toc-text">새로운 방법</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Layer"><span class="toc-number">3.1.</span> <span class="toc-text">Layer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DTO"><span class="toc-number">3.2.</span> <span class="toc-text">DTO</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Data-Aggregation"><span class="toc-number">3.3.</span> <span class="toc-text">Data Aggregation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EB%8D%B0%EC%9D%B4%ED%84%B0-%ED%86%A0%EB%A7%89%EC%B9%98%EA%B8%B0"><span class="toc-number">3.4.</span> <span class="toc-text">데이터 토막치기</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%EC%84%9C%EB%B2%84-%EA%B8%B0%EB%B0%98%EC%9D%84-%EC%88%98%EC%A0%95%ED%95%B4%EB%B3%B4%EC%9E%90"><span class="toc-number">4.</span> <span class="toc-text">서버 기반을 수정해보자</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%ED%81%B4%EB%9D%BC%EC%9D%B4%EC%96%B8%ED%8A%B8-%EA%B8%B0%EB%B0%98%EC%9D%84-%EC%88%98%EC%A0%95%ED%95%B4%EB%B3%B4%EC%9E%90"><span class="toc-number">5.</span> <span class="toc-text">클라이언트 기반을 수정해보자</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Multi-Store"><span class="toc-number">5.1.</span> <span class="toc-text">Multi Store</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%ED%81%B4%EB%9D%BC%EC%9D%B4%EC%96%B8%ED%8A%B8-%EB%9D%BC%EC%9A%B0%ED%8C%85"><span class="toc-number">5.2.</span> <span class="toc-text">클라이언트 라우팅</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EC%8A%A4%ED%81%AC%EB%A6%BD%ED%8A%B8-%EC%9A%A9%EB%9F%89-%EC%B6%95%EC%86%8C"><span class="toc-number">5.3.</span> <span class="toc-text">스크립트 용량 축소</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EC%BB%B4%ED%8F%AC%EB%84%8C%ED%8A%B8-%EC%9E%AC%EC%82%AC%EC%9A%A9%EC%84%B1"><span class="toc-number">5.4.</span> <span class="toc-text">컴포넌트 재사용성</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EC%82%AC%EC%9A%A9%EC%9E%90-%EC%95%A1%EC%85%98-%EC%B6%94%EC%A0%81-%EC%97%90%EB%9F%AC-%EB%A6%AC%ED%8F%AC%ED%8A%B8"><span class="toc-number">5.5.</span> <span class="toc-text">사용자 액션 추적 &#x2F; 에러 리포트</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%ED%81%B4%EB%9D%BC%EC%9D%B4%EC%96%B8%ED%8A%B8-%EB%8B%A8%EB%8F%85-%EA%B0%9C%EB%B0%9C%EC%9D%B4-%EA%B0%80%EB%8A%A5%ED%95%98%EB%8F%84%EB%A1%9D"><span class="toc-number">5.6.</span> <span class="toc-text">클라이언트 단독 개발이 가능하도록</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%EC%95%84%EC%A7%81%EC%9D%B4%EB%8B%A4"><span class="toc-number">6.</span> <span class="toc-text">아직이다</span></a></li></ol></div></div><script type="text/javascript">var GOOGLE_CUSTOM_SEARCH_API_KEY="",GOOGLE_CUSTOM_SEARCH_ENGINE_ID="",ALGOLIA_API_KEY="",ALGOLIA_APP_ID="",ALGOLIA_INDEX_NAME="",AZURE_SERVICE_NAME="",AZURE_INDEX_NAME="",AZURE_QUERY_KEY="",BAIDU_API_ID="",SEARCH_SERVICE="hexo"</script><script src="https://code.jquery.com/jquery-2.1.4.min.js"></script><script>window.jQuery||document.write('<script src="/js/jquery.js"><\/script>')</script><script src="/js/search.js"></script><script src="/js/app.js"></script><script type="text/javascript">var disqus_shortname="https-javarouka-github-io",disqus_url="https://blog.javarouka.me/2018/10/28/new_project_1/";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script><script>document.getElementById("loading-bar").style.width="100%"</script></body></html>