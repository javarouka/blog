<!DOCTYPE html><html><head><meta charset="utf-8"><title>Java HashMap 구현에 대해 (Effective java 3th - Item11) | NonBlock</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="equals를 재정의하려거든 hashCode도 재정의하라"><meta property="og:type" content="article"><meta property="og:title" content="Java HashMap 구현에 대해 (Effective java 3th - Item11)"><meta property="og:url" content="https://blog.javarouka.me/2018/11/28/java%EC%9D%98-HashMap-%EA%B5%AC%ED%98%84%EC%97%90-%EB%8C%80%ED%95%B4/index.html"><meta property="og:site_name" content="NonBlock"><meta property="og:description" content="equals를 재정의하려거든 hashCode도 재정의하라"><meta property="og:locale" content="ko_KR"><meta property="og:image" content="https://blog.javarouka.me/asset/images/effective/effective.webp"><meta property="article:published_time" content="2018-11-27T15:00:00.000Z"><meta property="article:modified_time" content="2020-09-22T04:18:02.875Z"><meta property="article:author" content="JavaRouka"><meta property="article:tag" content="java"><meta property="article:tag" content="effective"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://blog.javarouka.me/asset/images/effective/effective.webp"><link rel="apple-touch-icon" sizes="57x57" href="/fav/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/fav/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/fav/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/fav/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/fav/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/fav/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/fav/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/fav/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/fav/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/fav/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/fav/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/fav/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/fav/favicon-16x16.png"><link rel="manifest" href="/fav/manifest.json"><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/fav/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><meta name="keywords" content="java,effective"><link href="https://fonts.googleapis.com/css?family=Lato:400,400i,700" rel="stylesheet"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-85661914-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-85661914-1")</script><link rel="stylesheet" href="/icomoon/style.css"><link rel="stylesheet" href="/style.css"><script type="text/javascript">var __sauron=__sauron||[];__sauron.push(["pageview"]),function(){var e="https://analy1.sauroneyes.com/";__sauron.push(["setTrackerUrl",e+"analytics/"]);var a=document,r=a.createElement("script"),s=a.getElementsByTagName("script")[0];r.type="text/javascript",r.async=!0,r.defer=!0,r.src=e+"js/sauron.js",s.parentNode.insertBefore(r,s)}()</script><meta name="generator" content="Hexo 5.2.0"><link rel="stylesheet" href="/css/prism.css" type="text/css"><link rel="alternate" href="/atom.xml" title="NonBlock" type="application/atom+xml">
</head><body><div class="site-wrapper"><div id="loading-bar-wrapper"><div id="loading-bar"></div></div><script>document.getElementById("loading-bar").style.width="20%"</script><header id="header" class="site-header clearfix"><a class="logo square clearfix" href="/"><span class="b">N </span><span class="b">o </span><span class="b">n </span><span class="w">B </span><span class="b">l </span><span class="w">o </span><span class="b">c </span><span class="b">k </span></a><a class="me square site-nav-switch clearfix"><span class="b"><span class="icon icon-menu"></span></span></a></header><aside class="category-wrapper"><div class="site-category"><a class="nav flex-column-link" href="/categories/effective-java/">Effective Java</a><a class="nav flex-column-link" href="/categories/review/">Review</a><a class="nav flex-column-link" href="/categories/tech/">Tech</a><a class="nav flex-column-link" href="/categories/tech/translate/">Translate</a><a class="nav flex-column-link" href="/categories/book/">book</a><a class="nav flex-column-link" href="/categories/java/">java</a><a class="nav flex-column-link" href="/categories/java/kotlin/">kotlin</a><a class="nav flex-column-link" href="/categories/javascript/">javascript</a><a class="nav flex-column-link" href="/categories/javascript/react/">react</a><a class="nav flex-column-link" href="/categories/javascript/react/redux-saga/">redux-saga</a><a class="nav flex-column-link" href="/categories/kotlin/">kotlin</a><a class="nav flex-column-link" href="/categories/kotlin/tech/">tech</a><a class="nav flex-column-link" href="/categories/kotlin/tech/translate/">translate</a></div><div class="search"><form name="searchform" id="searchform" class="u-search-form"><input type="text" id="searchinput" class="u-search-input st-default-search-input" data-list-highlight="true" data-list-value-completion="true" placeholder="Looking for something in this blog?"> <button type="submit" id="u-search-btn-submit" class="u-search-btn-submit"><span class="icon icon-search"></span></button></form></div><script>document.getElementById("loading-bar").style.width="40%"</script><main id="main" class="clearfix"><article id="post-java의-HashMap-구현에-대해" class="article white-box article-type-post" itemscope itemprop="blogPost"><header class="article-header"><h1 class="article-title" itemprop="name">Java HashMap 구현에 대해 (Effective java 3th - Item11)</h1><h2 class="article-sub-title">equals를 재정의하려거든 hashCode도 재정의하라</h2><div class="article-meta">Posted on <time class="article-time" datetime="2018-11-27T15:00:00.000Z" itemprop="datePublished">2018-11-28</time></div></header><div class="article-entry" itemprop="articleBody"><h2 id="Map-인터페이스"><a href="#Map-인터페이스" class="headerlink" title="Map 인터페이스"></a>Map 인터페이스</h2><p>Map 같은 동작을 하는 키-값의 자료구조는 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://ko.wikipedia.org/wiki/%EC%97%B0%EA%B4%80_%EB%B0%B0%EC%97%B4">연관 배열</a>이라고 부르는 자료구조이다. 언어에 따라 Dictionary, Map, Symbol Table 등등으로 바꿔 부르기도 한다.</p><h3 id="JDK-8"><a href="#JDK-8" class="headerlink" title="JDK 8"></a>JDK 8</h3><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://docs.oracle.com/javase/9/docs/api/java/util/Map.html">Map Interface(JDK9 기준)</a> 는 단순하던 JDK 7 구현에서(기본적인 CRUD 성의 메서드 지원만 했다.) <code>default method</code> 가 추가된 JDK 8에서는 편의성 메서드들이 대거 추가되었다.</p><ul><li>편의성을 위해 지정된 값에 대해 일정 연산을 수행하고 그 결과를 갱신하는 compute, computeIfAbsent, computeIfPresent, merge</li><li>요소를 엔트리로 순회가능한 forEach</li><li>값을 보고 없으면 두번째 인자를 반환하는 getOrDefault</li><li>첫번째 인자로 준 키가 없을때만 넣는 putIfAbsent</li><li>값과 키 둘이 일치해야 삭제하는 remove(key, value)</li><li>값을 교체하는 replace, replaceAll</li></ul><p>이 중 getOrDefault 는 특정 경우에 따라 computeIfAbsent 와 대체해서 코드 량을 더욱 줄일 수 있다.</p><p>다음과 같은 코드를 보자.</p><p>키가 문자열이고 리스트가 값인 맵에서 특정 문자열 키의 값이 없다면 해당 값을 기본값을 리스트에 넣고 리스트를 값으로 put 하는 코드이다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, List&lt;String&gt;&gt; strListMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 기본값 넣기</span></span><br><span class="line">List&lt;String&gt; list = strListMap.getOrDefault(<span class="string">&quot;locale&quot;</span>, <span class="keyword">new</span> ArrayList&lt;&gt;());</span><br><span class="line">list.add(<span class="string">&quot;ko_KR&quot;</span>);</span><br><span class="line">strListMap.put(<span class="string">&quot;locale&quot;</span>, list);</span><br></pre></td></tr></table></figure><p>이 코드를 computeIfAbsent 와 람다로 한줄로 줄일 수 있다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, List&lt;String&gt;&gt; strListMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 기본값 넣기</span></span><br><span class="line">strListMap.computeIfAbsent(<span class="string">&quot;locale&quot;</span>, key -&gt; <span class="keyword">new</span> ArrayList&lt;&gt;()).add(<span class="string">&quot;ko_KR&quot;</span>);</span><br></pre></td></tr></table></figure><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://medium.com/@hun/java-8%EC%9D%98-%EB%9E%8C%EB%8B%A4-%ED%95%A8%EC%88%98-%EC%82%B4%ED%8E%B4%EB%B3%B4%EA%B8%B0-1767d034f962#e8d1">Java 8의 람다 함수 살펴보기:성능 비교</a> 를 참고해보자.</p><h3 id="JDK-9"><a href="#JDK-9" class="headerlink" title="JDK 9"></a>JDK 9</h3><p>JDK 9 에서는 좀더 기능이 확장되어 불변 맵을 생성하는 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://docs.oracle.com/javase/9/docs/api/java/util/Map.html#immutable">of default</a> 메서드가 추가되었다.</p><p>오버로딩이 꽤 많이 되어 최대 인자 20개로 10개까지의 원소를 가지는 맵을 생성할 수 있다. 구현이 너무 정직해서 놀랐다.</p><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/google/guava">Google Guava</a> 에는 이미 구현되어 있던 기능이다. 그냥 Guava를 정식 라이브러리로 하면 어떨까 싶다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, String&gt; immutableMap = Map.of(<span class="string">&quot;키1&quot;</span>, <span class="string">&quot;값1&quot;</span>, <span class="string">&quot;키2&quot;</span>, <span class="string">&quot;값2&quot;</span>);</span><br></pre></td></tr></table></figure><h2 id="Map-의-hash-함수"><a href="#Map-의-hash-함수" class="headerlink" title="Map 의 hash 함수"></a>Map 의 hash 함수</h2><p>Java 에서는 hashCode 라는 메서드가 기본적으로 최상위 클래스인 Object 에 존재한다.</p><p>이 코드로 Map 에 사용되는 key 를 대체하면 좋겠지만, hashCode 는 int 형이기에 Map 에 저장할 수 있는 객체의 숫자는 2의 32제곱의 사이즈만으로 제한될 것이다. 그렇다고 hashCode 를 long 으로 키워도 문제고, 다른 타입으로 교체할 경우 계산에 따른 성능 문제가 발생할 수 있다.</p><p>이런걸 다 무시하고 억지로 적용한다 쳐도, Map 이 생성될때마다 2의 32제곱의 사이즈만큼의 저장소(버킷이라고 한다)를 초기화해둬야 한다.</p><p>그래서 Map 의 버킷은 타협을 일정량의 버킷만 생성하고 몇가지 전략으로 버킷 충돌을 관리한다 (Open Addressing, Separate Chaining). Java 에서 사용하는 버킷 충돌 회피는 Separate Chaining 이며, 버킷을 일종의 LinkedList 로 관리한다.</p><p>버킷내의 충돌이 발생하면 기존 key와 신규 key의 equals 호출로 다시한번 중복여부를 검사하여 값을 교체하기에 키가 될 객체 Class 의 equals 구현은 상당히 중요하다.</p><p>hashCode 의 구현 규칙에서 <code>두 객체가 다르더라도 두 객체가 서로 다른 hashCode 를 반환하지 않아도 된다</code> 라는 건 이 때문이다.</p><p>하지만 둘다 다르게 구현하는게 Map의 성능 향상에 크게 도움이 된다. (특정 버킷에 편중되어 저장되는 현상을 회피할 수 있고, 충돌 버킷의 순회 비용이 줄어든다)</p><p>위 조건을 만족하는 hashCode 구현을 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://en.wikipedia.org/wiki/Perfect_hash_function">완전 해시 함수</a> 라고도 부른다</p></div><div class="article-tags"><a class="tag-none-link" href="/tags/effective/" rel="tag">effective</a><a class="tag-none-link" href="/tags/java/" rel="tag">java</a></div><section id="comments" class="white-box"><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></section></article><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5bf3f68d0a53e4d6"></script><script>document.getElementById("loading-bar").style.width="60%"</script></main><footer id="footer" class="clearfix"><div>&copy; <a href="https://blog.javarouka.me">NonBlock</a> Theme by <a href="http://artifact.me/" target="_blank" rel="external nofollow noopener noreferrer">Art Chen</a>.</div><div>Powered by <a target="_blank" href="https://hexo.io/" rel="external nofollow noopener noreferrer">Hexo</a>.</div></footer><script>document.getElementById("loading-bar").style.width="80%"</script><div class="overlay"></div></aside></div><div class="site-sidebar"><div class="sidebar-switch clearfix show" style="display:block"><a class="dark-btn active" data-toggle="toc"><span class="icon icon-list"></span> <span class="text">Index</span> </a><a class="dark-btn" data-toggle="bio"><span class="icon icon-person"></span> <span class="text">Bio</span></a></div><div class="site-bio" style="display:none"><div class="about-me clearfix"><div class="avatar"><img src="https://avatars2.githubusercontent.com/u/1438503?v=4&s=250"></div><div class="info"><a class="name dark-btn" href="/about">JavaRouka</a></div><div class="info"><span class="item desc">javarouka 의 기술블로그</span></div></div><div class="social clearfix"><a href="/atom.xml" class="feed" target="_blank" rel="external"><span class="icon icon-feed"></span> </a><a href="mailto:javarouka@gmail.com" class="mail" target="_blank" rel="external nofollow noopener noreferrer"><span class="icon icon-mail"></span> </a><a href="https://github.com/javarouka" class="github" target="_blank" rel="external nofollow noopener noreferrer"><span class="icon icon-github"></span> </a><a href="https://www.facebook.com/hanghui.i" class="facebook" target="_blank" rel="external nofollow noopener noreferrer"><span class="icon icon-facebook"></span></a></div><div class="shortcuts clearfix"><div class="bk"><a href="#header" class="dark-btn window-nav"><span class="icon icon-chevron-thin-up"></span> <span class="text">Back to Top</span></a></div><div class="bk"><a href="#footer" class="dark-btn window-nav"><span class="icon icon-chevron-thin-down"></span> <span class="text">Go to Bottom</span></a></div></div></div><div class="site-post-nav show" style="display:block"><div class="site-post-nav-box"><a href="/2019/04/02/redux-saga-1/" class="icon icon-chevron-thin-left"><a href="/2019/04/02/redux-saga-1/" class="site-post-nav-text">Redux-Saga 소개</a></a></div><div class="site-post-nav-box"><a href="/2018/11/27/object-equals-liskov/" class="site-post-nav-text">Equals 구현과 리스코프 치환 법칙 (Effective java 3th - Item10)</a> <a href="/2018/11/27/object-equals-liskov/" class="icon icon-chevron-thin-right"></a></div></div><div class="site-toc show" style="display:block"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Map-%EC%9D%B8%ED%84%B0%ED%8E%98%EC%9D%B4%EC%8A%A4"><span class="toc-number">1.</span> <span class="toc-text">Map 인터페이스</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#JDK-8"><span class="toc-number">1.1.</span> <span class="toc-text">JDK 8</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JDK-9"><span class="toc-number">1.2.</span> <span class="toc-text">JDK 9</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Map-%EC%9D%98-hash-%ED%95%A8%EC%88%98"><span class="toc-number">2.</span> <span class="toc-text">Map 의 hash 함수</span></a></li></ol></div></div><script type="text/javascript">var GOOGLE_CUSTOM_SEARCH_API_KEY="",GOOGLE_CUSTOM_SEARCH_ENGINE_ID="",ALGOLIA_API_KEY="",ALGOLIA_APP_ID="",ALGOLIA_INDEX_NAME="",AZURE_SERVICE_NAME="",AZURE_INDEX_NAME="",AZURE_QUERY_KEY="",BAIDU_API_ID="",SEARCH_SERVICE="hexo"</script><script src="https://code.jquery.com/jquery-2.1.4.min.js"></script><script>window.jQuery||document.write('<script src="/js/jquery.js"><\/script>')</script><script src="/js/search.js"></script><script src="/js/app.js"></script><script type="text/javascript">var disqus_shortname="https-javarouka-github-io",disqus_url="https://blog.javarouka.me/2018/11/28/java%EC%9D%98-HashMap-%EA%B5%AC%ED%98%84%EC%97%90-%EB%8C%80%ED%95%B4/";!function(){var a=document.createElement("script");a.type="text/javascript",a.async=!0,a.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}()</script><script>document.getElementById("loading-bar").style.width="100%"</script></body></html>