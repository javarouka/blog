<!DOCTYPE html><html><head><meta charset="utf-8"><title>Java 에서의 volatile 키워드 | NonBlock</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="Java 에서의 volatile 키워드"><meta property="og:type" content="article"><meta property="og:title" content="Java 에서의 volatile 키워드"><meta property="og:url" content="https://blog.javarouka.me/2012/01/01/volatile-in-java/index.html"><meta property="og:site_name" content="NonBlock"><meta property="og:description" content="Java 에서의 volatile 키워드"><meta property="og:locale" content="ko_KR"><meta property="og:image" content="https://blog.javarouka.me/asset/images/java-logo.png"><meta property="article:published_time" content="2011-12-31T15:00:00.000Z"><meta property="article:modified_time" content="2020-09-22T04:18:02.864Z"><meta property="article:author" content="JavaRouka"><meta property="article:tag" content="java"><meta property="article:tag" content="volatile"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://blog.javarouka.me/asset/images/java-logo.png"><link rel="apple-touch-icon" sizes="57x57" href="/fav/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/fav/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/fav/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/fav/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/fav/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/fav/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/fav/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/fav/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/fav/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/fav/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/fav/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/fav/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/fav/favicon-16x16.png"><link rel="manifest" href="/fav/manifest.json"><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/fav/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><meta name="keywords" content="java,volatile"><link href="https://fonts.googleapis.com/css?family=Lato:400,400i,700" rel="stylesheet"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-85661914-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-85661914-1")</script><link rel="stylesheet" href="/icomoon/style.css"><link rel="stylesheet" href="/style.css"><script type="text/javascript">var __sauron=__sauron||[];__sauron.push(["pageview"]),function(){var e="https://analy1.sauroneyes.com/";__sauron.push(["setTrackerUrl",e+"analytics/"]);var a=document,r=a.createElement("script"),s=a.getElementsByTagName("script")[0];r.type="text/javascript",r.async=!0,r.defer=!0,r.src=e+"js/sauron.js",s.parentNode.insertBefore(r,s)}()</script><meta name="generator" content="Hexo 5.2.0"><link rel="stylesheet" href="/css/prism.css" type="text/css"><link rel="alternate" href="/atom.xml" title="NonBlock" type="application/atom+xml">
</head><body><div class="site-wrapper"><div id="loading-bar-wrapper"><div id="loading-bar"></div></div><script>document.getElementById("loading-bar").style.width="20%"</script><header id="header" class="site-header clearfix"><a class="logo square clearfix" href="/"><span class="b">N </span><span class="w">o </span><span class="b">n </span><span class="b">B </span><span class="b">l </span><span class="w">o </span><span class="b">c </span><span class="w">k </span></a><a class="me square site-nav-switch clearfix"><span class="b"><span class="icon icon-menu"></span></span></a></header><aside class="category-wrapper"><div class="site-category"><a class="nav flex-column-link" href="/categories/effective-java/">Effective Java</a><a class="nav flex-column-link" href="/categories/review/">Review</a><a class="nav flex-column-link" href="/categories/tech/">Tech</a><a class="nav flex-column-link" href="/categories/tech/translate/">Translate</a><a class="nav flex-column-link" href="/categories/book/">book</a><a class="nav flex-column-link" href="/categories/java/">java</a><a class="nav flex-column-link" href="/categories/java/kotlin/">kotlin</a><a class="nav flex-column-link" href="/categories/javascript/">javascript</a><a class="nav flex-column-link" href="/categories/javascript/react/">react</a><a class="nav flex-column-link" href="/categories/javascript/react/redux-saga/">redux-saga</a><a class="nav flex-column-link" href="/categories/kotlin/">kotlin</a><a class="nav flex-column-link" href="/categories/kotlin/tech/">tech</a><a class="nav flex-column-link" href="/categories/kotlin/tech/translate/">translate</a></div><div class="search"><form name="searchform" id="searchform" class="u-search-form"><input type="text" id="searchinput" class="u-search-input st-default-search-input" data-list-highlight="true" data-list-value-completion="true" placeholder="Looking for something in this blog?"> <button type="submit" id="u-search-btn-submit" class="u-search-btn-submit"><span class="icon icon-search"></span></button></form></div><script>document.getElementById("loading-bar").style.width="40%"</script><main id="main" class="clearfix"><article id="post-volatile-in-java" class="article white-box article-type-post" itemscope itemprop="blogPost"><header class="article-header"><h1 class="article-title" itemprop="name">Java 에서의 volatile 키워드</h1><h2 class="article-sub-title">Java 에서의 volatile 키워드</h2><div class="article-meta">Posted on <time class="article-time" datetime="2011-12-31T15:00:00.000Z" itemprop="datePublished">2012-01-01</time></div></header><div class="article-entry" itemprop="articleBody"><h2 id="volatile"><a href="#volatile" class="headerlink" title="volatile?"></a>volatile?</h2><p><code>volatile</code> 은 멀티스레딩 환경시 동기화를 해주는 녀석 맞습니다. 읽기 쓰기시에 어떤 스레드가 값을 변경하든, 항상 최신값을 읽어갈 수 있게 해주죠.<br>그럼 <code>syncronized</code> 키워드하고는 뭐가 다른가?</p><p>작업 시 그 변수의 접근에 대해 같은 값을 읽어갈 수 있게 해주는 것은 volatile이나 syncronized나 동일합니다.</p><h2 id="읽고-쓰기에-대한-원자성"><a href="#읽고-쓰기에-대한-원자성" class="headerlink" title="읽고 쓰기에 대한 원자성"></a>읽고 쓰기에 대한 원자성</h2><p>하지만 volatile은 작업의 요소를 뺀 가시성, 즉 읽기, 쓰기동작에 대해서만 동기화가 됩니다. 그리고 그것은 원자성(Atomic)을 가집니다<br>말이 어려우니 예를 들면…</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> count = <span class="number">10</span>;</span><br></pre></td></tr></table></figure><p>이라는 변수가 있다고 가정하고 스레드 A와 B가 사용한다고 가정합니다.</p><p>거의 동시간에 A스레드가 count를 읽어 조작합니다. B도 같이 count를 읽어 조작합니다. 이 경우 두 스레드간에 count의 값은 서로 동일한 값, 즉 동일한 메모리 주소를 가르키지 않습니다.</p><p>스레드는 자신만의 저장 영역에 원본의 값을 복사하여 조작하기 때문이죠. 그래서 스레드마다 count는 다른 값을 가지고 있을 수 있습니다. A에서 변경한 값을 B에서는 영원히 읽어갈 수 없을수도 있습니다.</p><p>이런저런 과정 후에 A와 B의 스레드는 작업이 끝나면 다시 조작한 값을 원본 값으로 돌리는데 그 작업이 끝나지 않거나 배치 최적화(reordering. 밑에서 설명) 등으로 그러지 않을 수 있습니다.</p><p>그럼 변수 count는 스레드간 불일치가 일어나겠죠.</p><h2 id="리오더링-회피"><a href="#리오더링-회피" class="headerlink" title="리오더링 회피"></a>리오더링 회피</h2><p>또한 변수 읽기 불일치는 일종의 최적화인 리오더링 결과로 발생하기도 합니다.<br>리오더링은 보통 컴파일 과정에서 일어나며, 프로그래머가 만들어낸 코드는 컴파일 될 때 좀더 빠르게 실행될 수 있도록 조작을 가하는 최적화를 거칩니다.<br>그러한 최적화 과정중에 읽기와 쓰기의 순서가 바뀔 수 있는데, 그럴 경우 자칫 순서가 중요한 멀티스레드 환경에서 문제가 발생할 수 있습니다.</p><p>volatile을 쓴 변수는 리오더링에서 제외되며, 항상 프로그래머가 지정한 순서로 읽기 및 쓰기를 수행합니다.</p><h2 id="연산의-원자성"><a href="#연산의-원자성" class="headerlink" title="연산의 원자성"></a>연산의 원자성</h2><p>이것은 가장 처음의 문제와 같은 특성인데요.</p><p>보통 변수의 쓰기 읽기는 일견 원자성(누군가 끼어들 틈이 없는 완벽한 작업단위로 이해합시다…)을 띌 수도 있어 보입니다만, 실제 count에 변수가 할당될 때 완벽히 한 메모리 작업 안에서 완벽히 쓰여지지 않습니다.</p><p>아, int같은 데이터 타입은 한번에 씁니다…;</p><p>그러나 그보다 더 큰 타입, long이나 객체..그리고 변수 할당 및 연산 시 일어나는 작업에서는 완벽히 원자성을 가지지 않고 여러번에 걸쳐 메모리 작업이 일어납니다.<br>(엄밀히 말하면 JVM 구현에 따라 다를 수 있다고 합니다…)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">long</span> stat = <span class="number">324L</span>;</span><br></pre></td></tr></table></figure><p>위 코드에서 long은 데이터형이 8바이트. 즉 64비트입니다. 자바는 여기에 변수를 할당할 때 32비트 단위로 끊어서 할당합니다. 첫 32비트 할당 그다음 32비트 할당…</p><p>첫 32비트를 할당했을때 다른 스레드가 값을 읽어간다면…? 정상적이지 않은 상황이 나오겠죠 (물론 무지하게 짧은 순간입니다)</p><p>stat 변수가 volatile 키워드 변수라면 할당이 원자성을 가지게 되어 문제가 발생하지 않습니다.</p><p>syncronized랑 다를게 없네? 아닙니다. 아래 코드를 보면</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> val = stat + <span class="number">10</span>;</span><br></pre></td></tr></table></figure><p>이 코드는 val에 volatile 선언을 해 둬도, 멀티 스레딩 시 위험합니다.</p><p>분명 스레드의 접근 순서에 따라 val의 값을 어떤 스레드는 10을 더한값을 가져가기도 하고, 어떤 스레드는 10을 더하지 않은 값을 읽기도 할것입니다. 위 코드의 작업은 stat을 int로 캐스팅하고 10을 더하고 다시 val에 할당하는 3가지의 작업을 거치기 때문이죠.</p><p>syncronized는 이럴 때 작업자체를 원자화해버립니다. <code>volatile</code> 이 할 수 없는 일이죠.</p><h2 id="1-5이전버전-유의"><a href="#1-5이전버전-유의" class="headerlink" title="1.5이전버전 유의"></a>1.5이전버전 유의</h2><p>volatile 사용시에는 자바 버전에 주의해야 합니다.</p><p>1.5 이전 버전에서는 정상 지원이 되지 않고 있거든요. 그 이후라면 안전하게 보장해준다고 합니다.</p></div><div class="article-tags"><a class="tag-none-link" href="/tags/java/" rel="tag">java</a><a class="tag-none-link" href="/tags/volatile/" rel="tag">volatile</a></div><section id="comments" class="white-box"><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></section></article><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5bf3f68d0a53e4d6"></script><script>document.getElementById("loading-bar").style.width="60%"</script></main><footer id="footer" class="clearfix"><div>&copy; <a href="https://blog.javarouka.me">NonBlock</a> Theme by <a href="http://artifact.me/" target="_blank" rel="external nofollow noopener noreferrer">Art Chen</a>.</div><div>Powered by <a target="_blank" href="https://hexo.io/" rel="external nofollow noopener noreferrer">Hexo</a>.</div></footer><script>document.getElementById("loading-bar").style.width="80%"</script><div class="overlay"></div></aside></div><div class="site-sidebar"><div class="sidebar-switch clearfix show" style="display:block"><a class="dark-btn active" data-toggle="toc"><span class="icon icon-list"></span> <span class="text">Index</span> </a><a class="dark-btn" data-toggle="bio"><span class="icon icon-person"></span> <span class="text">Bio</span></a></div><div class="site-bio" style="display:none"><div class="about-me clearfix"><div class="avatar"><img src="https://avatars2.githubusercontent.com/u/1438503?v=4&s=250"></div><div class="info"><a class="name dark-btn" href="/about">JavaRouka</a></div><div class="info"><span class="item desc">javarouka 의 기술블로그</span></div></div><div class="social clearfix"><a href="/atom.xml" class="feed" target="_blank" rel="external"><span class="icon icon-feed"></span> </a><a href="mailto:javarouka@gmail.com" class="mail" target="_blank" rel="external nofollow noopener noreferrer"><span class="icon icon-mail"></span> </a><a href="https://github.com/javarouka" class="github" target="_blank" rel="external nofollow noopener noreferrer"><span class="icon icon-github"></span> </a><a href="https://www.facebook.com/hanghui.i" class="facebook" target="_blank" rel="external nofollow noopener noreferrer"><span class="icon icon-facebook"></span></a></div><div class="shortcuts clearfix"><div class="bk"><a href="#header" class="dark-btn window-nav"><span class="icon icon-chevron-thin-up"></span> <span class="text">Back to Top</span></a></div><div class="bk"><a href="#footer" class="dark-btn window-nav"><span class="icon icon-chevron-thin-down"></span> <span class="text">Go to Bottom</span></a></div></div></div><div class="site-post-nav show" style="display:block"><div class="site-post-nav-box"><a href="/2012/01/01/internal-external-iterator/" class="icon icon-chevron-thin-left"><a href="/2012/01/01/internal-external-iterator/" class="site-post-nav-text">이터레이터 패턴의 내부 반복자와 외부 반복자</a></a></div><div class="site-post-nav-box"><a href="/2011/09/11/new-string/" class="site-post-nav-text">자바 new String() 시 초보들이 하기 쉬운 실수...</a> <a href="/2011/09/11/new-string/" class="icon icon-chevron-thin-right"></a></div></div><div class="site-toc show" style="display:block"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#volatile"><span class="toc-number">1.</span> <span class="toc-text">volatile?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%EC%9D%BD%EA%B3%A0-%EC%93%B0%EA%B8%B0%EC%97%90-%EB%8C%80%ED%95%9C-%EC%9B%90%EC%9E%90%EC%84%B1"><span class="toc-number">2.</span> <span class="toc-text">읽고 쓰기에 대한 원자성</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%EB%A6%AC%EC%98%A4%EB%8D%94%EB%A7%81-%ED%9A%8C%ED%94%BC"><span class="toc-number">3.</span> <span class="toc-text">리오더링 회피</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%EC%97%B0%EC%82%B0%EC%9D%98-%EC%9B%90%EC%9E%90%EC%84%B1"><span class="toc-number">4.</span> <span class="toc-text">연산의 원자성</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-5%EC%9D%B4%EC%A0%84%EB%B2%84%EC%A0%84-%EC%9C%A0%EC%9D%98"><span class="toc-number">5.</span> <span class="toc-text">1.5이전버전 유의</span></a></li></ol></div></div><script type="text/javascript">var GOOGLE_CUSTOM_SEARCH_API_KEY="",GOOGLE_CUSTOM_SEARCH_ENGINE_ID="",ALGOLIA_API_KEY="",ALGOLIA_APP_ID="",ALGOLIA_INDEX_NAME="",AZURE_SERVICE_NAME="",AZURE_INDEX_NAME="",AZURE_QUERY_KEY="",BAIDU_API_ID="",SEARCH_SERVICE="hexo"</script><script src="https://code.jquery.com/jquery-2.1.4.min.js"></script><script>window.jQuery||document.write('<script src="/js/jquery.js"><\/script>')</script><script src="/js/search.js"></script><script src="/js/app.js"></script><script type="text/javascript">var disqus_shortname="https-javarouka-github-io",disqus_url="https://blog.javarouka.me/2012/01/01/volatile-in-java/";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script><script>document.getElementById("loading-bar").style.width="100%"</script></body></html>